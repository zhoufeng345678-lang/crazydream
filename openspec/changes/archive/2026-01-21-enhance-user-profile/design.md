## Context

当前用户管理系统采用DDD（领域驱动设计）架构，用户资料更新功能较为简单，仅支持昵称和头像URL的更新。本次需要扩展以下能力：

1. **手机号管理**：支持用户绑定手机号，为后续的手机号登录、短信验证等功能预留基础
2. **微信集成**：支持绑定微信OpenID，为微信登录、微信支付等功能预留基础
3. **头像上传**：实现真正的文件上传到阿里云OSS功能，而非仅接受URL字符串

### 技术栈
- Spring Boot 3.2.0
- 阿里云OSS SDK 3.17.1（已集成）
- MyBatis 3.0.3
- MySQL 8.0

### 约束条件
- 数据库schema已包含phone和openid字段，无需DDL变更
- 保持向后兼容，新增字段均为可选
- 遵循现有DDD架构模式（值对象、聚合根、仓储）

## Goals / Non-Goals

### Goals
1. 用户可通过API更新手机号码和微信OpenID
2. 用户可上传头像图片文件，系统自动上传至OSS并返回URL
3. 手机号格式验证（中国大陆手机号：11位数字，1开头）
4. 文件上传安全性（类型、大小限制）
5. 保持现有API向后兼容

### Non-Goals
1. 手机号短信验证功能（未来需求）
2. 微信登录OAuth流程实现（未来需求）
3. 头像图片压缩/裁剪功能
4. 多头像版本管理（缩略图等）
5. 旧头像文件清理机制

## Decisions

### 1. 值对象设计
**决策**：为phone和wechatOpenId创建独立值对象（而非直接使用String）

**理由**：
- 符合DDD最佳实践，封装验证逻辑
- 提供类型安全，防止误传参数
- 便于后续扩展（如手机号脱敏显示）

**备选方案**：直接使用String字段
- 优点：实现简单
- 缺点：验证逻辑分散，缺乏类型安全

### 2. OSS文件路径规则
**决策**：使用 `avatars/{userId}/{timestamp}-{uuid}.{ext}` 格式

**理由**：
- userId分组便于管理和权限控制
- timestamp + uuid保证唯一性
- 保留原始扩展名便于识别

**备选方案**：`avatars/{uuid}.{ext}`（扁平结构）
- 优点：路径更短
- 缺点：无法按用户管理，未来清理困难

### 3. 文件上传接口设计
**决策**：新增独立的 `POST /api/v2/users/avatar` 接口

**理由**：
- 文件上传与资料更新语义不同
- 支持multipart/form-data content-type
- 便于添加文件预处理逻辑（如将来的压缩）

**备选方案**：在updateProfile接口中同时处理文件上传
- 优点：接口数量少
- 缺点：混合JSON和文件上传复杂，不符合RESTful最佳实践

### 4. 手机号验证规则
**决策**：仅验证中国大陆手机号格式（11位数字，1开头）

**理由**：
- 当前用户群体主要在中国大陆
- 简化实现和验证逻辑
- 未来可扩展国际手机号支持

### 5. 字段可选性
**决策**：phone和wechatOpenId均为可选字段，可为null

**理由**：
- 保持向后兼容
- 用户可以选择性绑定
- 不影响现有注册登录流程

## Risks / Trade-offs

### 风险1：OSS上传失败
- **缓解措施**：添加重试机制，返回明确错误信息给前端
- **回退方案**：暂时允许用户输入URL作为降级方案

### 风险2：文件大小攻击
- **缓解措施**：限制文件大小为5MB，Spring配置中设置max-file-size
- **监控**：记录上传失败日志，监控异常上传行为

### 风险3：手机号重复绑定
- **当前处理**：暂不添加唯一性约束（允许多个账号绑定同一手机号）
- **未来优化**：需求明确后再添加唯一索引和业务校验

### Trade-off：值对象复杂度
- **成本**：增加Phone和WechatOpenId两个值对象类
- **收益**：类型安全、验证逻辑封装、符合DDD架构
- **结论**：收益大于成本，值得投入

## Migration Plan

### 数据库迁移
- **无需迁移**：user表已包含phone和openid字段
- **验证**：执行SELECT查询确认字段存在

### 代码部署
1. 发布新版本代码
2. 验证/api/v2/users/avatar接口可用
3. 验证updateProfile接口兼容新字段
4. 监控错误日志和OSS上传成功率

### 回滚计划
- 如OSS集成出现问题，可回滚到上一版本
- 数据库无变更，回滚无数据风险
- 已上传的OSS文件保留，不影响回滚

## Open Questions

1. **Q**: 手机号是否需要唯一性约束？
   **A**: 当前不添加，等待产品需求明确

2. **Q**: 微信OpenID如何获取？
   **A**: 当前仅提供存储能力，获取逻辑由前端或后续微信登录功能实现

3. **Q**: OSS bucket是否已创建并配置公开读权限？
   **A**: 需在实现前与运维确认，确保头像文件可公开访问

4. **Q**: 头像文件保留策略？
   **A**: 当前不实现清理逻辑，未来考虑定期清理未使用的文件
