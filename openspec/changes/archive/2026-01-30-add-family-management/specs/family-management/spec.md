# family-management Specification Delta

## ADDED Requirements

### Requirement: FM-001 家庭成员管理
**Priority**: P0  
**Category**: Core Feature

系统 SHALL 提供家庭成员的完整生命周期管理能力，包括添加、查询、更新、删除家庭成员信息。

家庭成员 SHALL 包含以下信息：
- 姓名（必填）
- 关系类型（必填，如：父亲、母亲、配偶、子女、兄弟姐妹等）
- 生日（可选，DATE 格式）
- 手机号（可选）
- 头像 URL（可选）
- 备注（可选）

每个家庭成员 SHALL 关联到特定用户，用户只能管理自己的家庭成员数据。

#### Scenario: 成功添加家庭成员

**Given** 用户已登录，userId 为 123  
**And** 用户提交家庭成员信息：
```json
{
  "name": "张三",
  "relationType": "FATHER",
  "birthday": "1960-05-15",
  "phone": "13800138000",
  "notes": "需要定期体检"
}
```
**When** 用户调用添加家庭成员接口 `POST /api/v2/family/members`  
**Then** 系统应：
- 验证姓名和关系类型不为空
- 创建 FamilyMember 聚合根
- 保存到 family_member 表
- 自动为用户创建生日提醒（如果填写了生日）
- 返回成功响应，包含新创建的成员 ID

**And** 返回的数据结构应包含：
```json
{
  "success": true,
  "data": {
    "id": 1,
    "name": "张三",
    "relationType": "FATHER",
    "relationTypeDesc": "父亲",
    "birthday": "1960-05-15",
    "phone": "13800138000",
    "avatar": null,
    "notes": "需要定期体检",
    "createTime": "2026-01-30T10:00:00",
    "updateTime": "2026-01-30T10:00:00"
  }
}
```

#### Scenario: 添加家庭成员时必填项缺失

**Given** 用户已登录  
**When** 用户提交的家庭成员信息缺少姓名或关系类型  
**Then** 系统应：
- 返回参数校验错误
- 错误信息为 "姓名不能为空" 或 "关系类型不能为空"
- HTTP 状态码为 400

#### Scenario: 成功查询家庭成员列表

**Given** 用户已登录，userId 为 123  
**And** 用户已添加 3 个家庭成员  
**When** 用户调用查询家庭成员列表接口 `GET /api/v2/family/members`  
**Then** 系统应：
- 仅返回该用户的家庭成员（通过 user_id 过滤）
- 按创建时间倒序排列
- 返回所有成员的完整信息

#### Scenario: 成功更新家庭成员信息

**Given** 用户已登录，userId 为 123  
**And** 用户拥有一个家庭成员记录，id 为 1  
**When** 用户调用更新接口 `PUT /api/v2/family/members/1`  
**And** 更新数据包含修改后的手机号和备注  
**Then** 系统应：
- 验证该成员属于当前用户
- 更新家庭成员信息
- 如果生日信息发生变化，更新或创建对应的生日提醒
- 返回更新后的成员信息

#### Scenario: 无权限更新其他用户的家庭成员

**Given** 用户 A（userId=123）已登录  
**And** 用户 B（userId=456）拥有一个家庭成员记录，id 为 2  
**When** 用户 A 尝试更新家庭成员 2 的信息  
**Then** 系统应：
- 返回权限错误
- 错误信息为 "无权限操作该家庭成员"
- HTTP 状态码为 403

#### Scenario: 成功删除家庭成员

**Given** 用户已登录，userId 为 123  
**And** 用户拥有一个家庭成员记录，id 为 1  
**When** 用户调用删除接口 `DELETE /api/v2/family/members/1`  
**Then** 系统应：
- 验证该成员属于当前用户
- 删除家庭成员记录
- 级联删除该成员的所有体检记录
- 删除该成员关联的生日提醒
- 返回成功响应

---

### Requirement: FM-002 关系类型定义
**Priority**: P0  
**Category**: Core Feature

系统 SHALL 提供预定义的家庭关系类型枚举，确保数据一致性和类型安全。

支持的关系类型 SHALL 包括：
- FATHER（父亲）
- MOTHER（母亲）
- SPOUSE（配偶）
- SON（儿子）
- DAUGHTER（女儿）
- BROTHER（兄弟）
- SISTER（姐妹）
- GRANDFATHER（祖父/外祖父）
- GRANDMOTHER（祖母/外祖母）
- OTHER（其他）

每个关系类型 SHALL 包含中文描述，便于前端展示。

#### Scenario: 使用有效的关系类型

**Given** 用户准备添加家庭成员  
**When** 用户选择关系类型为 "FATHER"  
**Then** 系统应：
- 接受该关系类型
- 在数据库中存储为 "FATHER"
- 在返回数据中提供中文描述 "父亲"

#### Scenario: 使用无效的关系类型

**Given** 用户准备添加家庭成员  
**When** 用户提交的关系类型为 "INVALID_TYPE"  
**Then** 系统应：
- 返回参数校验错误
- 错误信息为 "不支持的关系类型"

---

### Requirement: FM-003 生日提醒自动创建
**Priority**: P1  
**Category**: Integration Feature

系统 SHALL 在添加或更新家庭成员时，如果成员有生日信息，自动创建或更新对应的生日提醒。

生日提醒 SHALL 符合以下规则：
- 提醒时间：每年生日前 7 天
- 提醒类型：BIRTHDAY
- 提醒内容："{成员姓名}的生日即将到来（{月-日}）"
- 关联实体：关联到家庭成员 ID

如果家庭成员的生日信息被删除，系统 SHALL 同时删除对应的生日提醒。

#### Scenario: 添加有生日的家庭成员自动创建提醒

**Given** 用户已登录，userId 为 123  
**And** 用户添加家庭成员，姓名为"张三"，生日为"1960-05-15"  
**When** 系统保存家庭成员成功  
**Then** 系统应：
- 自动创建一条生日提醒记录
- 提醒类型为 "BIRTHDAY"
- 提醒内容为 "张三的生日即将到来（05-15）"
- 提醒时间为每年的 5 月 8 日（提前 7 天）
- 关联的实体类型为 "FAMILY_MEMBER"
- 关联的实体 ID 为该家庭成员的 ID

#### Scenario: 更新生日信息自动更新提醒

**Given** 用户已登录，用户拥有家庭成员"张三"，原生日为"1960-05-15"  
**And** 系统已创建对应的生日提醒  
**When** 用户更新张三的生日为"1960-06-20"  
**Then** 系统应：
- 删除旧的生日提醒
- 创建新的生日提醒，提醒时间为 6 月 13 日（提前 7 天）
- 提醒内容更新为 "张三的生日即将到来（06-20）"

#### Scenario: 删除生日信息自动删除提醒

**Given** 用户已登录，用户拥有家庭成员"张三"，生日为"1960-05-15"  
**And** 系统已创建对应的生日提醒  
**When** 用户更新张三的信息，将生日字段设置为空  
**Then** 系统应：
- 删除对应的生日提醒记录
- 保留家庭成员的其他信息

---

### Requirement: FM-004 健康体检管理
**Priority**: P1  
**Category**: Core Feature

系统 SHALL 提供健康体检记录的管理能力，用户可以为家庭成员添加体检记录，并设置下次体检日期。

体检记录 SHALL 包含以下信息：
- 所属家庭成员 ID（必填）
- 体检日期（必填）
- 下次体检日期（可选）
- 体检医院（可选）
- 备注（可选）

当设置了下次体检日期时，系统 SHALL 自动创建体检提醒，提前 30 天提醒用户。

#### Scenario: 成功添加体检记录并创建提醒

**Given** 用户已登录，userId 为 123  
**And** 用户拥有家庭成员"张三"，id 为 1  
**And** 用户提交体检记录信息：
```json
{
  "checkupDate": "2026-01-15",
  "nextCheckupDate": "2027-01-15",
  "hospital": "人民医院",
  "notes": "体检正常"
}
```
**When** 用户调用添加体检记录接口 `POST /api/v2/family/members/1/checkups`  
**Then** 系统应：
- 验证家庭成员属于当前用户
- 创建体检记录并保存到 health_checkup 表
- 自动创建体检提醒，提醒时间为 2026-12-16（提前 30 天）
- 提醒类型为 "HEALTH_CHECKUP"
- 提醒内容为 "张三的健康体检到期提醒"
- 返回成功响应

#### Scenario: 查询家庭成员的体检记录列表

**Given** 用户已登录，userId 为 123  
**And** 用户拥有家庭成员"张三"，id 为 1  
**And** 该成员有 3 条体检记录  
**When** 用户调用查询体检记录接口 `GET /api/v2/family/members/1/checkups`  
**Then** 系统应：
- 验证家庭成员属于当前用户
- 返回该成员的所有体检记录
- 按体检日期倒序排列
- 每条记录包含完整的体检信息

#### Scenario: 删除体检记录自动删除提醒

**Given** 用户已登录，userId 为 123  
**And** 用户拥有一条体检记录，id 为 10  
**And** 系统已为该体检记录创建了提醒  
**When** 用户调用删除体检记录接口 `DELETE /api/v2/family/checkups/10`  
**Then** 系统应：
- 验证该体检记录属于当前用户的家庭成员
- 删除体检记录
- 删除对应的体检提醒
- 返回成功响应

#### Scenario: 无权限删除其他用户的体检记录

**Given** 用户 A（userId=123）已登录  
**And** 用户 B（userId=456）拥有一条体检记录，id 为 20  
**When** 用户 A 尝试删除体检记录 20  
**Then** 系统应：
- 返回权限错误
- 错误信息为 "无权限操作该体检记录"
- HTTP 状态码为 403

---

### Requirement: FM-005 数据隔离与权限控制
**Priority**: P0  
**Category**: Security

系统 SHALL 确保用户只能访问和管理自己的家庭成员数据，通过 user_id 进行数据隔离。

所有家庭管理相关的 API 接口 SHALL 要求用户登录，并验证 JWT Token。

在执行任何家庭成员或体检记录的增删改查操作时，系统 SHALL 验证当前用户是否有权限操作该数据。

#### Scenario: 未登录用户访问家庭管理接口

**Given** 用户未登录（无 JWT Token）  
**When** 用户访问任何家庭管理 API 接口  
**Then** 系统应：
- 返回认证错误
- 错误信息为 "未登录或登录已过期"
- HTTP 状态码为 401

#### Scenario: 用户只能查看自己的家庭成员

**Given** 用户 A（userId=123）已登录  
**And** 数据库中有用户 A 的 2 个家庭成员和用户 B 的 3 个家庭成员  
**When** 用户 A 调用查询家庭成员列表接口  
**Then** 系统应：
- 只返回用户 A 的 2 个家庭成员
- 不返回用户 B 的家庭成员数据

#### Scenario: 跨用户操作被拒绝

**Given** 用户 A（userId=123）已登录  
**And** 家庭成员记录 X 属于用户 B（userId=456）  
**When** 用户 A 尝试更新或删除家庭成员记录 X  
**Then** 系统应：
- 验证失败，返回权限错误
- HTTP 状态码为 403

---

### Requirement: FM-006 前端用户界面
**Priority**: P0  
**Category**: Frontend Feature

系统 SHALL 提供用户友好的前端界面，支持家庭成员和体检记录的可视化管理。

前端 SHALL 包含以下页面：
1. **家庭成员列表页**：展示所有家庭成员卡片
2. **成员表单页**：添加或编辑家庭成员
3. **生日提醒页**：展示即将到来的生日列表
4. **体检管理页**：查看和管理体检记录

所有页面 SHALL 遵循微信小程序设计规范，提供清晰的导航和用户提示。

#### Scenario: 在个人中心访问家庭管理

**Given** 用户已登录小程序  
**When** 用户进入"我的"（个人中心）页面  
**Then** 页面应显示"家庭管理"入口  
**And** 点击该入口应跳转到家庭成员列表页

#### Scenario: 查看家庭成员列表

**Given** 用户已登录并进入家庭成员列表页  
**And** 用户有 3 个家庭成员  
**When** 页面加载完成  
**Then** 应显示 3 个成员卡片  
**And** 每个卡片显示：姓名、关系、生日、头像（如有）  
**And** 页面应提供"添加成员"按钮  
**And** 每个卡片应支持点击进入编辑

#### Scenario: 添加新家庭成员

**Given** 用户在家庭成员列表页  
**When** 用户点击"添加成员"按钮  
**Then** 应跳转到成员表单页（添加模式）  
**And** 表单包含字段：姓名、关系类型、生日、手机号、头像、备注  
**And** 姓名和关系类型标记为必填  
**When** 用户填写完信息并提交  
**Then** 应调用后端 API 创建成员  
**And** 成功后返回列表页并刷新数据

#### Scenario: 查看即将到来的生日

**Given** 用户进入生日提醒页  
**And** 用户有 2 个家庭成员的生日在未来 30 天内  
**When** 页面加载完成  
**Then** 应显示这 2 个成员的生日信息  
**And** 按日期从近到远排序  
**And** 每个条目显示：成员姓名、关系、生日日期、距离天数

#### Scenario: 管理体检记录

**Given** 用户进入体检管理页  
**And** 用户有 2 个家庭成员，其中 1 个有体检记录  
**When** 页面加载完成  
**Then** 应显示所有家庭成员列表  
**And** 有体检记录的成员显示最近一次体检日期和下次体检日期  
**And** 支持点击成员查看详细体检历史  
**And** 支持添加新的体检记录
